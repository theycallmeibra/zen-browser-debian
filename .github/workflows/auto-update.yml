name: Auto-Update Zen Browser

on:
  schedule:
    - cron: '0 4 * * *'  # Checks every day at 4:00 AM UTC
  workflow_dispatch:      # Allows you to click a button to run it manually

permissions:
  contents: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper fakeroot jq

      - name: Check for Updates
        id: check
        run: |
          # 1. Get Latest Upstream Version (Zen Browser)
          UPSTREAM_JSON=$(curl -s https://api.github.com/repos/zen-browser/desktop/releases/latest)
          UPSTREAM_TAG=$(echo "$UPSTREAM_JSON" | jq -r .tag_name)
          VERSION="${UPSTREAM_TAG//v/}"
          
          # 2. Get Latest Local Version (From your repo)
          LOCAL_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' || echo "none")
          
          echo "Upstream: $UPSTREAM_TAG"
          echo "Local:    $LOCAL_TAG"
          
          if [ "$UPSTREAM_TAG" == "$LOCAL_TAG" ]; then
            echo "Already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "New version found!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
            
            # Find the correct download URL for Linux x86_64
            DOWNLOAD_URL=$(echo "$UPSTREAM_JSON" | jq -r '.assets[] | select(.name | test("linux.*tar\\.(bz2|gz|xz)$")) | .browser_download_url' | head -n 1)
            echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        if: steps.check.outputs.update_needed == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      - name: Prepare Source & Build
        if: steps.check.outputs.update_needed == 'true'
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          TAG="${{ steps.check.outputs.tag }}"
          URL="${{ steps.check.outputs.download_url }}"
          
          # 1. Download Original Source
          wget -O zen-browser_$VERSION.orig.tar.xz "$URL"
          
          # 2. Update Changelog
          # This updates debian/changelog with the new version number
          dch -v "$VERSION-1" --distribution unstable "New upstream release $TAG"
          
          # 3. Create Build Directory
          mkdir -p zen-browser-$VERSION
          # Extract using --strip-components to handle varied upstream folder names
          tar -xf zen-browser_$VERSION.orig.tar.xz -C zen-browser-$VERSION --strip-components=1
          
          # 4. Copy debian folder into build directory
          cp -r debian zen-browser-$VERSION/
          
          # 5. Build Source Package
          cd zen-browser-$VERSION
          debuild -S -uc -us

      - name: Create Release & Upload Artifacts
        if: steps.check.outputs.update_needed == 'true'
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          TAG="${{ steps.check.outputs.tag }}"
          
          # Commit the updated changelog back to the repo
          git add debian/changelog
          git commit -m "Update to $TAG"
          git push
          
          # Create Release and Upload Files
          gh release create "$TAG" \
            ../zen-browser_${VERSION}.orig.tar.xz \
            ../zen-browser_${VERSION}-1.debian.tar.xz \
            ../zen-browser_${VERSION}-1.dsc \
            --title "Zen Browser $TAG" \
            --notes "Auto-generated Debian source package for $TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
